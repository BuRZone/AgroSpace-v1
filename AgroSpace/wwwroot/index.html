<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroSpace - Карта полей</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px 300px;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .map-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar, .fields-sidebar {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        /* Стили для WebKit браузеров (Chrome, Safari, Edge) */
        .sidebar::-webkit-scrollbar, .fields-sidebar::-webkit-scrollbar {
            width: 8px;
            border-radius: 15px;
        }

        .sidebar::-webkit-scrollbar-track, .fields-sidebar::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 15px;
            margin: 5px;
        }

        .sidebar::-webkit-scrollbar-thumb, .fields-sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            border: 1px solid #f0f0f0;
        }

        .sidebar::-webkit-scrollbar-thumb:hover, .fields-sidebar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .field-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .field-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .field-item-highlighted {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%) !important;
            color: white !important;
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.3);
            border-left: 4px solid #fff !important;
        }

        .field-item-highlighted .field-name {
            color: white !important;
        }

        .field-item-highlighted .field-size {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .field-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .field-size {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 12px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            border-radius: 12px;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .coordinates-display {
            background: #f0f8ff;
            border: 1px solid #2196f3;
            border-radius: 12px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        /* Скрываем подписи OpenLayers */
        .ol-attribution {
            display: none !important;
        }

        /* Стили для пасхалки */
        .easter-egg-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
            animation: slideInRight 0.5s ease-out;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .easter-egg-notification.hide {
            animation: slideOutRight 0.5s ease-in forwards;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .easter-egg-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .easter-egg-coords {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: center;
        }

        .easter-egg-timer {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
        }

        .easter-egg-clicks {
            text-align: center;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .easter-egg-polygon {
            position: absolute;
            pointer-events: none;
            z-index: 999;
        }

        .victory-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2000;
            animation: victoryPulse 2s ease-out;
        }

        @keyframes victoryPulse {
            0% {
                background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, transparent 70%);
                transform: scale(0);
            }
            50% {
                background: radial-gradient(circle, rgba(255,215,0,0.6) 0%, transparent 70%);
                transform: scale(1.2);
            }
            100% {
                background: radial-gradient(circle, rgba(255,215,0,0) 0%, transparent 70%);
                transform: scale(2);
            }
        }

        .victory-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 2001;
            animation: victoryText 2s ease-out;
        }

        @keyframes victoryText {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .click-result {
            position: fixed;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1500;
            pointer-events: none;
            animation: fadeInOut 2s ease-out;
        }

        /* Стили для переключателя пасхалки */
        .easter-egg-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 999;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-width: 200px;
            display: none;
        }

        .easter-egg-controls.show {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }

        .easter-egg-controls h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            text-align: center;
        }

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #ff6b6b;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .switch-label {
            font-size: 12px;
            color: #666;
        }

        .interval-settings {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            display: none;
        }

        .interval-settings.show {
            display: block;
        }

        .interval-input {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }

        .interval-input input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
        }

        .interval-input label {
            font-size: 11px;
            color: #666;
        }



        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                order: -1;
            }

            .easter-egg-notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌾 AgroSpace</h1>
            <p>Интерактивная карта сельскохозяйственных полей</p>
            <!-- <button id="test-easter-egg" class="btn" style="margin-top: 10px; width: auto; padding: 8px 16px; font-size: 12px; background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);">
                🎯 Тест пасхалки
            </button> -->
        </div>

        <!-- Уведомление пасхалки -->
        <div id="easter-egg-notification" class="easter-egg-notification" style="display: none;">
            <div class="easter-egg-title">🎯 Пасхалка!</div>
            <div class="easter-egg-coords" id="easter-egg-coords"></div>
            <div class="easter-egg-timer" id="easter-egg-timer">01:00</div>
            <div class="easter-egg-clicks" id="easter-egg-clicks">Кликов: 0/5</div>
            <div style="text-align: center; font-size: 12px; opacity: 0.8;">
                Попадите в область за 5 кликов!
            </div>
        </div>

        <!-- Панель управления пасхалкой -->
        <div id="easter-egg-controls" class="easter-egg-controls">
            <h4>🎯 Управление пасхалкой</h4>
            <div class="switch-container">
                <span class="switch-label">Включить пасхалку</span>
                <label class="switch">
                    <input type="checkbox" id="easter-egg-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div id="interval-settings" class="interval-settings">
                <div class="interval-input">
                    <input type="number" id="interval-minutes" min="1" max="60" value="5">
                    <label for="interval-minutes">минут</label>
                </div>
                <div class="interval-input">
                    <input type="number" id="interval-seconds" min="0" max="59" value="0">
                    <label for="interval-seconds">секунд</label>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="sidebar">
                <div class="section">
                    <h3>📍 Проверка точки</h3>
                    <form id="point-form">
                        <div class="form-group">
                            <label for="lat">Широта:</label>
                            <input type="number" id="lat" step="any" placeholder="41.3380610642585" required>
                        </div>
                        <div class="form-group">
                            <label for="lng">Долгота:</label>
                            <input type="number" id="lng" step="any" placeholder="45.6962567581079" required>
                        </div>
                        <button type="submit" class="btn">Проверить принадлежность</button>
                    </form>
                    <div id="point-result"></div>
                </div>

                <div class="section">
                    <h3>📏 Расстояние до центра</h3>
                    <form id="distance-form">
                        <div class="form-group">
                            <label for="field-id">ID поля:</label>
                            <input type="number" id="field-id" placeholder="1" required min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="distance-lat">Широта:</label>
                            <input type="number" id="distance-lat" step="any" placeholder="41.3380610642585" required>
                        </div>
                        <div class="form-group">
                            <label for="distance-lng">Долгота:</label>
                            <input type="number" id="distance-lng" step="any" placeholder="45.6962567581079" required>
                        </div>
                        <button type="submit" class="btn">Вычислить расстояние</button>
                    </form>
                    <div id="distance-result"></div>
                </div>

                <div class="section">
                    <h3>🎯 Координаты клика</h3>
                    <div id="click-coordinates" class="coordinates-display">
                        Кликните на карту для получения координат
                    </div>
                </div>
            </div>

            <div class="fields-sidebar">
                <div class="section">
                    <h3>📊 Информация о полях</h3>
                    <div id="fields-info">
                        <div class="loading">Загрузка данных...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
    <script>
        let map;
        let fields = [];
        let fieldPolygons = [];
        let fieldMarkers = [];
        let clickMarkerLayer = null;
        let distanceLabelLayer = null;
        let distanceLineLayer = null;

        // Инициализация карты
        function initMap() {
            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM({
                            attributions: [] // Убираем подписи
                        })
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([41.3380610642585, 45.6962567581079]),
                    zoom: 13
                })
            });

            // Обработчик клика по карте
            map.on('click', function(e) {
                const coords = ol.proj.toLonLat(e.coordinate);
                const lat = coords[1].toFixed(12);
                const lng = coords[0].toFixed(12);
                
                // Обрабатываем пасхалку
                handleEasterEggClick(parseFloat(lat), parseFloat(lng));
                
                document.getElementById('click-coordinates').innerHTML = 
                    `Широта: ${lat}<br>Долгота: ${lng}`;
                
                // Автозаполнение форм
                document.getElementById('lat').value = lat;
                document.getElementById('lng').value = lng;
                document.getElementById('distance-lat').value = lat;
                document.getElementById('distance-lng').value = lng;

                // Очищаем результат расстояния при перемещении точки
                document.getElementById('distance-result').innerHTML = '';
                // Очищаем результат проверки принадлежности при перемещении точки
                document.getElementById('point-result').innerHTML = '';

                // Удаляем предыдущий маркер, если был
                if (clickMarkerLayer) {
                    map.removeLayer(clickMarkerLayer);
                }
                
                // Удаляем подпись расстояния и линию, если были
                if (distanceLabelLayer) {
                    map.removeLayer(distanceLabelLayer);
                    distanceLabelLayer = null;
                }
                if (distanceLineLayer) {
                    map.removeLayer(distanceLineLayer);
                    distanceLineLayer = null;
                }
                
                // Сбрасываем подсветку поля в списке при перемещении точки
                clearFieldListHighlight();
                // Добавляем новый маркер
                clickMarkerLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [
                            new ol.Feature({
                                geometry: new ol.geom.Point(e.coordinate)
                            })
                        ]
                    }),
                    style: new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 7,
                            fill: new ol.style.Fill({ color: '#2196f3' }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                        })
                    })
                });
                map.addLayer(clickMarkerLayer);
            });
        }

        // Загрузка данных о полях
        async function loadFields() {
            try {
                const response = await fetch('/api/fields');
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                
                fields = await response.json();
                displayFieldsInfo();
                displayFieldsOnMap();
                
                // Центрируем карту на первом поле при загрузке
                if (fields.length > 0) {
                    const firstField = fields[0];
                    map.getView().setCenter(
                        ol.proj.fromLonLat([firstField.locations.center.lng, firstField.locations.center.lat])
                    );
                    map.getView().setZoom(13);
                }
            } catch (error) {
                console.error('Ошибка загрузки полей:', error);
                document.getElementById('fields-info').innerHTML = 
                    '<div class="error">Ошибка загрузки данных о полях</div>';
            }
        }

        // Отображение информации о полях
        function displayFieldsInfo() {
            const container = document.getElementById('fields-info');
            container.innerHTML = fields.map(field => `
                <div class="field-item" data-field-id="${field.id}" onclick="highlightField(${field.id})">
                    <div class="field-name">${field.name}</div>
                    <div class="field-size">Площадь: ${field.size} га</div>
                </div>
            `).join('');
        }

        // Отображение полей на карте
        function displayFieldsOnMap() {
            // Очистка предыдущих элементов
            fieldPolygons.forEach(polygon => map.removeLayer(polygon));
            fieldMarkers.forEach(marker => map.removeLayer(marker));
            fieldPolygons = [];
            fieldMarkers = [];

            fields.forEach(field => {
                // Создание полигона
                const polygonCoords = field.locations.polygon.map(coord => 
                    ol.proj.fromLonLat([coord.lng, coord.lat])
                );
                
                const polygon = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [
                            new ol.Feature({
                                geometry: new ol.geom.Polygon([polygonCoords])
                            })
                        ]
                    }),
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#667eea',
                            width: 2
                        }),
                        fill: new ol.style.Fill({
                            color: 'rgba(102, 126, 234, 0.2)'
                        })
                    })
                });

                map.addLayer(polygon);
                fieldPolygons.push(polygon);

                // Создание маркера центра с подписью
                const marker = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [
                            new ol.Feature({
                                geometry: new ol.geom.Point(
                                    ol.proj.fromLonLat([field.locations.center.lng, field.locations.center.lat])
                                ),
                                name: field.name,
                                size: field.size
                            })
                        ]
                    }),
                    style: function(feature) {
                        return [
                            new ol.style.Style({
                                image: new ol.style.Circle({
                                    radius: 6,
                                    fill: new ol.style.Fill({
                                        color: '#ff4444'
                                    }),
                                    stroke: new ol.style.Stroke({
                                        color: 'white',
                                        width: 2
                                    })
                                })
                            }),
                            new ol.style.Style({
                                geometry: function(feature) {
                                    const geometry = feature.getGeometry();
                                    const extent = geometry.getExtent();
                                    const center = ol.extent.getCenter(extent);
                                    const offset = [0, -20]; // Смещение текста выше маркера
                                    return new ol.geom.Point([center[0] + offset[0], center[1] + offset[1]]);
                                },
                                text: new ol.style.Text({
                                    text: `${feature.get('name')}\n${feature.get('size')} га`,
                                    font: '12px Arial',
                                    fill: new ol.style.Fill({
                                        color: '#333'
                                    }),
                                    stroke: new ol.style.Stroke({
                                        color: 'white',
                                        width: 3
                                    }),
                                    textAlign: 'center',
                                    offsetY: -10
                                })
                            })
                        ];
                    }
                });

                map.addLayer(marker);
                fieldMarkers.push(marker);
            });
        }

        // Подсветка поля
        function highlightField(fieldId) {
            const field = fields.find(f => f.id === fieldId);
            if (field) {
                // Центрируем карту на поле
                map.getView().setCenter(
                    ol.proj.fromLonLat([field.locations.center.lng, field.locations.center.lat])
                );
                
                // Подсвечиваем выбранное поле
                highlightSelectedField(fieldId);
            }
        }

        // Подсветка выбранного поля
        function highlightSelectedField(fieldId) {
            // Сбрасываем все поля к обычному стилю
            fieldPolygons.forEach((polygon, index) => {
                const field = fields[index];
                if (field) {
                    polygon.setStyle(new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: fieldId && field.id === fieldId ? '#ff4444' : '#667eea',
                            width: fieldId && field.id === fieldId ? 4 : 2
                        }),
                        fill: new ol.style.Fill({
                            color: fieldId && field.id === fieldId ? 'rgba(255, 68, 68, 0.3)' : 'rgba(102, 126, 234, 0.2)'
                        })
                    }));
                }
            });
        }

        // Подсветка поля в списке и прокрутка к нему
        function highlightFieldInList(fieldId) {
            // Сбрасываем предыдущую подсветку
            clearFieldListHighlight();
            
            // Находим элемент поля в списке
            const fieldElement = document.querySelector(`[data-field-id="${fieldId}"]`);
            if (fieldElement) {
                // Добавляем класс подсветки
                fieldElement.classList.add('field-item-highlighted');
                
                // Прокручиваем к элементу
                fieldElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        // Сброс подсветки в списке
        function clearFieldListHighlight() {
            const highlightedElements = document.querySelectorAll('.field-item-highlighted');
            highlightedElements.forEach(element => {
                element.classList.remove('field-item-highlighted');
            });
        }

        // Проверка принадлежности точки
        async function checkPointLocation(lat, lng) {
            try {
                const response = await fetch('/api/fields/point-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lat, lng })
                });

                if (!response.ok) throw new Error('Ошибка запроса');
                
                const result = await response.json();
                const resultDiv = document.getElementById('point-result');
                
                if (result === false) {
                    resultDiv.innerHTML = '<div class="result">Точка не принадлежит ни одному полю</div>';
                    // Сбрасываем подсветку всех полей
                    highlightSelectedField(null);
                    // Сбрасываем подсветку в списке
                    clearFieldListHighlight();
                } else {
                    resultDiv.innerHTML = `
                        <div class="result">
                            <strong>Точка находится в поле:</strong><br>
                            ID: ${result.id}<br>
                            Название: ${result.name}
                        </div>
                    `;
                    // Подсвечиваем поле, в котором находится точка
                    highlightSelectedField(result.id);
                    
                    // Подсвечиваем поле в списке и прокручиваем к нему
                    highlightFieldInList(result.id);
                    
                    // Автоматически подставляем ID поля в форму расстояния
                    document.getElementById('field-id').value = result.id;
                }
            } catch (error) {
                console.error('Ошибка проверки точки:', error);
                document.getElementById('point-result').innerHTML = 
                    '<div class="error">Ошибка при проверке точки</div>';
            }
        }

        // Вычисление расстояния
        async function calculateDistance(fieldId, lat, lng) {
            try {
                const response = await fetch('/api/fields/distance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fieldId, lat, lng })
                });

                if (!response.ok) throw new Error('Ошибка запроса');
                
                const distance = await response.json();
                const resultDiv = document.getElementById('distance-result');
                
                resultDiv.innerHTML = `
                    <div class="result">
                        <strong>Расстояние:</strong> ${distance.toFixed(2)} метров
                    </div>
                `;

                // Подсвечиваем выбранное поле
                highlightSelectedField(fieldId);

                // Добавляем подпись к маркеру точки
                addDistanceLabelToMarker(lat, lng, distance, fieldId);
                
                // Рисуем линию до центра поля
                drawDistanceLine(lat, lng, fieldId);
            } catch (error) {
                console.error('Ошибка вычисления расстояния:', error);
                document.getElementById('distance-result').innerHTML = 
                    '<div class="error">Ошибка при вычислении расстояния</div>';
            }
        }

        // Добавление подписи к маркеру точки
        function addDistanceLabelToMarker(lat, lng, distance, fieldId) {
            // Удаляем предыдущую подпись, если была
            if (distanceLabelLayer) {
                map.removeLayer(distanceLabelLayer);
            }

            const field = fields.find(f => f.id === fieldId);
            if (!field) return;

            distanceLabelLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
                        })
                    ]
                }),
                style: new ol.style.Style({
                    text: new ol.style.Text({
                        text: `${distance.toFixed(1)} м`,
                        font: 'bold 12px Arial',
                        fill: new ol.style.Fill({
                            color: '#333'
                        }),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 3
                        }),
                        offsetY: -25,
                        textAlign: 'center'
                    })
                })
            });

            map.addLayer(distanceLabelLayer);
        }

        // Рисование линии до центра поля
        function drawDistanceLine(lat, lng, fieldId) {
            // Удаляем предыдущую линию, если была
            if (distanceLineLayer) {
                map.removeLayer(distanceLineLayer);
            }

            const field = fields.find(f => f.id === fieldId);
            if (!field) return;

            const startPoint = ol.proj.fromLonLat([lng, lat]);
            const endPoint = ol.proj.fromLonLat([field.locations.center.lng, field.locations.center.lat]);

            distanceLineLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({
                            geometry: new ol.geom.LineString([startPoint, endPoint])
                        })
                    ]
                }),
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#ff4444',
                        width: 2,
                        lineDash: [5, 5]
                    })
                })
            });

            map.addLayer(distanceLineLayer);
        }

        // Обработчики форм
        document.getElementById('point-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const lat = parseFloat(document.getElementById('lat').value);
            const lng = parseFloat(document.getElementById('lng').value);
            checkPointLocation(lat, lng);
        });

        document.getElementById('distance-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const fieldId = parseInt(document.getElementById('field-id').value);
            const lat = parseFloat(document.getElementById('distance-lat').value);
            const lng = parseFloat(document.getElementById('distance-lng').value);
            calculateDistance(fieldId, lat, lng);
        });

        // Обработчик изменения ID поля в форме расстояния
        document.getElementById('field-id').addEventListener('change', function(e) {
            const fieldId = parseInt(e.target.value);
            if (fieldId > 0) {
                highlightSelectedField(fieldId);
            }
        });

        // Переменные для пасхалки
        let easterEggActive = false;
        let easterEggPolygon = null;
        let easterEggCenter = null;
        let easterEggClickCount = 0;
        let easterEggTimer = null;
        let easterEggTimeLeft = 60; // 60 секунд
        let easterEggInterval = null;
        let easterEggEnabled = true;
        let easterEggIntervalMs = 5 * 60 * 1000; // 5 минут по умолчанию
        let easterEggMainTimer = null;
        let easterEggControlsShown = false;

        // Генерация случайных координат по всей карте
        function generateRandomCoordinates() {
            // Устанавливаем границы для генерации координат по всей карте
            // Используем разумные границы для Земли
            const minLon = -180; // Западная граница
            const maxLon = 180;  // Восточная граница
            const minLat = -85;  // Южная граница (исключаем полюса)
            const maxLat = 85;   // Северная граница (исключаем полюса)
            
            const centerLon = minLon + Math.random() * (maxLon - minLon);
            const centerLat = minLat + Math.random() * (maxLat - minLat);
            
            return { lng: centerLon, lat: centerLat };
        }

        // Создание полигона вокруг центральной точки
        function createEasterEggPolygon(center) {
            const radius = 0.005; // Радиус полигона в градусах (примерно 500 метров)
            const points = [];
            
            for (let i = 0; i < 8; i++) {
                const angle = (i * Math.PI * 2) / 8;
                const lat = center.lat + radius * Math.cos(angle);
                const lng = center.lng + radius * Math.sin(angle);
                points.push([lng, lat]);
            }
            
            return points;
        }

        // Показ уведомления пасхалки
        function showEasterEggNotification() {
            if (easterEggActive) return;
            
            easterEggActive = true;
            easterEggClickCount = 0;
            easterEggTimeLeft = 60;
            
            // Показываем панель управления только при первом появлении пасхалки
            if (!easterEggControlsShown) {
                setTimeout(() => {
                    showEasterEggControls();
                }, 2000); // Показываем через 2 секунды после появления пасхалки
            }
            

            
            // Генерируем случайные координаты
            easterEggCenter = generateRandomCoordinates();
            console.log('Сгенерированные координаты пасхалки:', easterEggCenter);
            const polygonCoords = createEasterEggPolygon(easterEggCenter);
            
            // Создаем полигон на карте
            easterEggPolygon = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({
                            geometry: new ol.geom.Polygon([polygonCoords.map(coord => 
                                ol.proj.fromLonLat(coord)
                            )])
                        })
                    ]
                }),
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#ff6b6b',
                        width: 3,
                        lineDash: [10, 5]
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 107, 107, 0.1)'
                    })
                })
            });
            
            map.addLayer(easterEggPolygon);
            

            
            // Показываем уведомление
            const notification = document.getElementById('easter-egg-notification');
            document.getElementById('easter-egg-coords').textContent = 
                `Центр: ${easterEggCenter.lat.toFixed(6)}, ${easterEggCenter.lng.toFixed(6)}`;
            document.getElementById('easter-egg-clicks').textContent = 'Кликов: 0/5';
            notification.style.display = 'block';
            
            // Запускаем таймер
            easterEggInterval = setInterval(updateEasterEggTimer, 1000);
            
            // Автоматически скрываем через 60 секунд
            easterEggTimer = setTimeout(() => {
                hideEasterEggNotification();
            }, 60000);
        }

        // Обновление таймера пасхалки
        function updateEasterEggTimer() {
            easterEggTimeLeft--;
            const minutes = Math.floor(easterEggTimeLeft / 60);
            const seconds = easterEggTimeLeft % 60;
            document.getElementById('easter-egg-timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (easterEggTimeLeft <= 0) {
                hideEasterEggNotification();
            }
        }

        // Скрытие уведомления пасхалки
        function hideEasterEggNotification() {
            easterEggActive = false;
            
            if (easterEggPolygon) {
                map.removeLayer(easterEggPolygon);
                easterEggPolygon = null;
            }
            
            if (easterEggInterval) {
                clearInterval(easterEggInterval);
                easterEggInterval = null;
            }
            
            if (easterEggTimer) {
                clearTimeout(easterEggTimer);
                easterEggTimer = null;
            }
            

            
            const notification = document.getElementById('easter-egg-notification');
            notification.classList.add('hide');
            setTimeout(() => {
                notification.style.display = 'none';
                notification.classList.remove('hide');
            }, 500);
            
            // Перезапускаем основной таймер пасхалки после завершения игры
            if (easterEggEnabled) {
                startEasterEggTimer();
            }
        }

        // Проверка попадания в полигон пасхалки
        function checkEasterEggHit(lat, lng) {
            if (!easterEggActive || !easterEggPolygon) return false;
            
            const point = new ol.geom.Point(ol.proj.fromLonLat([lng, lat]));
            const polygon = easterEggPolygon.getSource().getFeatures()[0].getGeometry();
            
            return polygon.intersectsCoordinate(point.getCoordinates());
        }

        // Вычисление расстояния до центра пасхалки
        function calculateDistanceToEasterEggCenter(lat, lng) {
            if (!easterEggCenter) return 0;
            
            const R = 6371000; // Радиус Земли в метрах
            const lat1 = lat * Math.PI / 180;
            const lat2 = easterEggCenter.lat * Math.PI / 180;
            const deltaLat = (easterEggCenter.lat - lat) * Math.PI / 180;
            const deltaLng = (easterEggCenter.lng - lng) * Math.PI / 180;
            
            const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                     Math.cos(lat1) * Math.cos(lat2) *
                     Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            
            return R * c;
        }

        // Показ результата клика
        function showClickResult(lat, lng, distance, hit) {
            const result = document.createElement('div');
            result.className = 'click-result';
            result.style.left = event.clientX + 'px';
            result.style.top = event.clientY + 'px';
            
            if (hit) {
                result.textContent = `🎯 Попадание! Расстояние: ${distance.toFixed(1)}м`;
                result.style.color = '#4caf50';
            } else {
                result.textContent = `❌ Промах! Расстояние: ${distance.toFixed(1)}м`;
                result.style.color = '#f44336';
            }
            
            document.body.appendChild(result);
            
            setTimeout(() => {
                document.body.removeChild(result);
            }, 2000);
        }

        // Эффект победы
        function showVictoryEffect() {
            // Создаем эффект пульсации
            const effect = document.createElement('div');
            effect.className = 'victory-effect';
            document.body.appendChild(effect);
            
            // Создаем текст победы
            const victoryText = document.createElement('div');
            victoryText.className = 'victory-text';
            victoryText.textContent = '🎉 ПОБЕДА! 🎉';
            document.body.appendChild(victoryText);
            
            // Удаляем эффекты через 2 секунды
            setTimeout(() => {
                document.body.removeChild(effect);
                document.body.removeChild(victoryText);
            }, 2000);
        }

        // Обработка клика по карте для пасхалки
        function handleEasterEggClick(lat, lng) {
            if (!easterEggActive) return;
            
            easterEggClickCount++;
            document.getElementById('easter-egg-clicks').textContent = `Кликов: ${easterEggClickCount}/5`;
            
            const distance = calculateDistanceToEasterEggCenter(lat, lng);
            const hit = checkEasterEggHit(lat, lng);
            
            console.log('Клик пасхалки:', { lat, lng, distance, hit, center: easterEggCenter });
            
            showClickResult(lat, lng, distance, hit);
            
            if (hit) {
                showVictoryEffect();
                hideEasterEggNotification();
            } else if (easterEggClickCount >= 5) {
                hideEasterEggNotification();
            }
        }



        // Запуск пасхалки с настраиваемым интервалом
        function startEasterEggTimer() {
            if (easterEggMainTimer) {
                clearInterval(easterEggMainTimer);
            }
            
            easterEggMainTimer = setInterval(() => {
                if (easterEggEnabled) {
                    showEasterEggNotification();
                }
            }, easterEggIntervalMs);
        }

        // Остановка основного таймера пасхалки
        function stopEasterEggTimer() {
            if (easterEggMainTimer) {
                clearInterval(easterEggMainTimer);
                easterEggMainTimer = null;
            }
        }

        // Показ панели управления пасхалкой
        function showEasterEggControls() {
            const controls = document.getElementById('easter-egg-controls');
            controls.classList.add('show');
            easterEggControlsShown = true;
        }



        // Обновление интервала пасхалки
        function updateEasterEggInterval() {
            const minutes = parseInt(document.getElementById('interval-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('interval-seconds').value) || 0;
            
            easterEggIntervalMs = (minutes * 60 + seconds) * 1000;
            
            if (easterEggEnabled) {
                startEasterEggTimer();
            }
        }

        // Переключение состояния пасхалки
        function toggleEasterEgg(enabled) {
            easterEggEnabled = enabled;
            
            if (enabled) {
                startEasterEggTimer();
            } else {
                stopEasterEggTimer();
            }
        }

        // Обработчики событий для пасхалки
        document.addEventListener('DOMContentLoaded', function() {
            // Обработчик кнопки тестирования пасхалки
            const testButton = document.getElementById('test-easter-egg');
            if (testButton) {
                testButton.addEventListener('click', function() {
                    if (!easterEggActive) {
                        showEasterEggNotification();
                    }
                });
            }

            // Обработчик переключателя пасхалки
            const toggleSwitch = document.getElementById('easter-egg-toggle');
            if (toggleSwitch) {
                toggleSwitch.addEventListener('change', function() {
                    toggleEasterEgg(this.checked);
                    
                    // Показываем/скрываем настройки интервала
                    const intervalSettings = document.getElementById('interval-settings');
                    if (this.checked) {
                        intervalSettings.classList.add('show');
                    } else {
                        intervalSettings.classList.remove('show');
                    }
                });
            }

            // Обработчики полей интервала
            const intervalMinutes = document.getElementById('interval-minutes');
            const intervalSeconds = document.getElementById('interval-seconds');
            
            if (intervalMinutes) {
                intervalMinutes.addEventListener('change', updateEasterEggInterval);
            }
            if (intervalSeconds) {
                intervalSeconds.addEventListener('change', updateEasterEggInterval);
            }

            // Инициализация настроек интервала
            const intervalSettings = document.getElementById('interval-settings');
            if (intervalSettings) {
                intervalSettings.classList.add('show');
            }

            // Убираем автоматическое скрытие панели при клике вне её
            // Панель будет скрываться только при нажатии кнопки закрытия


        });

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadFields();
            startEasterEggTimer();
        });
    </script>
</body>
</html> 