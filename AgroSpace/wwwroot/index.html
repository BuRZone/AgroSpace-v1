<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroSpace - –ö–∞—Ä—Ç–∞ –ø–æ–ª–µ–π</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px 300px;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .map-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar, .fields-sidebar {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f0f0f0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è WebKit –±—Ä–∞—É–∑–µ—Ä–æ–≤ (Chrome, Safari, Edge) */
        .sidebar::-webkit-scrollbar, .fields-sidebar::-webkit-scrollbar {
            width: 8px;
            border-radius: 15px;
        }

        .sidebar::-webkit-scrollbar-track, .fields-sidebar::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 15px;
            margin: 5px;
        }

        .sidebar::-webkit-scrollbar-thumb, .fields-sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            border: 1px solid #f0f0f0;
        }

        .sidebar::-webkit-scrollbar-thumb:hover, .fields-sidebar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .field-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .field-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .field-item-highlighted {
            background: linear-gradient(135deg, #ff4444 0%, #ff6666 100%) !important;
            color: white !important;
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(255, 68, 68, 0.3);
            border-left: 4px solid #fff !important;
        }

        .field-item-highlighted .field-name {
            color: white !important;
        }

        .field-item-highlighted .field-size {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .field-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .field-size {
            color: #666;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 12px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            border-radius: 12px;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .coordinates-display {
            background: #f0f8ff;
            border: 1px solid #2196f3;
            border-radius: 12px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ OpenLayers */
        .ol-attribution {
            display: none !important;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåæ AgroSpace</h1>
            <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å–µ–ª—å—Å–∫–æ—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π</p>
        </div>

        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="sidebar">
                <div class="section">
                    <h3>üìç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–∫–∏</h3>
                    <form id="point-form">
                        <div class="form-group">
                            <label for="lat">–®–∏—Ä–æ—Ç–∞:</label>
                            <input type="number" id="lat" step="any" placeholder="41.3380610642585" required>
                        </div>
                        <div class="form-group">
                            <label for="lng">–î–æ–ª–≥–æ—Ç–∞:</label>
                            <input type="number" id="lng" step="any" placeholder="45.6962567581079" required>
                        </div>
                        <button type="submit" class="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å</button>
                    </form>
                    <div id="point-result"></div>
                </div>

                <div class="section">
                    <h3>üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–Ω—Ç—Ä–∞</h3>
                    <form id="distance-form">
                        <div class="form-group">
                            <label for="field-id">ID –ø–æ–ª—è:</label>
                            <input type="number" id="field-id" placeholder="1" required min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="distance-lat">–®–∏—Ä–æ—Ç–∞:</label>
                            <input type="number" id="distance-lat" step="any" placeholder="41.3380610642585" required>
                        </div>
                        <div class="form-group">
                            <label for="distance-lng">–î–æ–ª–≥–æ—Ç–∞:</label>
                            <input type="number" id="distance-lng" step="any" placeholder="45.6962567581079" required>
                        </div>
                        <button type="submit" class="btn">–í—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ</button>
                    </form>
                    <div id="distance-result"></div>
                </div>

                <div class="section">
                    <h3>üéØ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞</h3>
                    <div id="click-coordinates" class="coordinates-display">
                        –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    </div>
                </div>
            </div>

            <div class="fields-sidebar">
                <div class="section">
                    <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—è—Ö</h3>
                    <div id="fields-info">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
    <script>
        let map;
        let fields = [];
        let fieldPolygons = [];
        let fieldMarkers = [];
        let clickMarkerLayer = null;
        let distanceLabelLayer = null;
        let distanceLineLayer = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM({
                            attributions: [] // –£–±–∏—Ä–∞–µ–º –ø–æ–¥–ø–∏—Å–∏
                        })
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([41.3380610642585, 45.6962567581079]),
                    zoom: 13
                })
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', function(e) {
                const coords = ol.proj.toLonLat(e.coordinate);
                const lat = coords[1].toFixed(12);
                const lng = coords[0].toFixed(12);
                
                document.getElementById('click-coordinates').innerHTML = 
                    `–®–∏—Ä–æ—Ç–∞: ${lat}<br>–î–æ–ª–≥–æ—Ç–∞: ${lng}`;
                
                // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º
                document.getElementById('lat').value = lat;
                document.getElementById('lng').value = lng;
                document.getElementById('distance-lat').value = lat;
                document.getElementById('distance-lng').value = lng;

                // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —Ç–æ—á–∫–∏
                document.getElementById('distance-result').innerHTML = '';
                // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —Ç–æ—á–∫–∏
                document.getElementById('point-result').innerHTML = '';

                // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä–∫–µ—Ä, –µ—Å–ª–∏ –±—ã–ª
                if (clickMarkerLayer) {
                    map.removeLayer(clickMarkerLayer);
                }
                
                // –£–¥–∞–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ –ª–∏–Ω–∏—é, –µ—Å–ª–∏ –±—ã–ª–∏
                if (distanceLabelLayer) {
                    map.removeLayer(distanceLabelLayer);
                    distanceLabelLayer = null;
                }
                if (distanceLineLayer) {
                    map.removeLayer(distanceLineLayer);
                    distanceLineLayer = null;
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–ª—è –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ —Ç–æ—á–∫–∏
                clearFieldListHighlight();
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
                clickMarkerLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [
                            new ol.Feature({
                                geometry: new ol.geom.Point(e.coordinate)
                            })
                        ]
                    }),
                    style: new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 7,
                            fill: new ol.style.Fill({ color: '#2196f3' }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
                        })
                    })
                });
                map.addLayer(clickMarkerLayer);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—è—Ö
        async function loadFields() {
            try {
                const response = await fetch('/api/fields');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                
                fields = await response.json();
                displayFieldsInfo();
                displayFieldsOnMap();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–µ–π:', error);
                document.getElementById('fields-info').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—è—Ö</div>';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—è—Ö
        function displayFieldsInfo() {
            const container = document.getElementById('fields-info');
            container.innerHTML = fields.map(field => `
                <div class="field-item" data-field-id="${field.id}" onclick="highlightField(${field.id})">
                    <div class="field-name">${field.name}</div>
                    <div class="field-size">–ü–ª–æ—â–∞–¥—å: ${field.size} –≥–∞</div>
                </div>
            `).join('');
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ
        function displayFieldsOnMap() {
            // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            fieldPolygons.forEach(polygon => map.removeLayer(polygon));
            fieldMarkers.forEach(marker => map.removeLayer(marker));
            fieldPolygons = [];
            fieldMarkers = [];

            fields.forEach(field => {
                // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–∏–≥–æ–Ω–∞
                const polygonCoords = field.locations.polygon.map(coord => 
                    ol.proj.fromLonLat([coord.lng, coord.lat])
                );
                
                const polygon = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [
                            new ol.Feature({
                                geometry: new ol.geom.Polygon([polygonCoords])
                            })
                        ]
                    }),
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#667eea',
                            width: 2
                        }),
                        fill: new ol.style.Fill({
                            color: 'rgba(102, 126, 234, 0.2)'
                        })
                    })
                });

                map.addLayer(polygon);
                fieldPolygons.push(polygon);

                // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ —Ü–µ–Ω—Ç—Ä–∞ —Å –ø–æ–¥–ø–∏—Å—å—é
                const marker = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [
                            new ol.Feature({
                                geometry: new ol.geom.Point(
                                    ol.proj.fromLonLat([field.locations.center.lng, field.locations.center.lat])
                                ),
                                name: field.name,
                                size: field.size
                            })
                        ]
                    }),
                    style: function(feature) {
                        return [
                            new ol.style.Style({
                                image: new ol.style.Circle({
                                    radius: 6,
                                    fill: new ol.style.Fill({
                                        color: '#ff4444'
                                    }),
                                    stroke: new ol.style.Stroke({
                                        color: 'white',
                                        width: 2
                                    })
                                })
                            }),
                            new ol.style.Style({
                                geometry: function(feature) {
                                    const geometry = feature.getGeometry();
                                    const extent = geometry.getExtent();
                                    const center = ol.extent.getCenter(extent);
                                    const offset = [0, -20]; // –°–º–µ—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤—ã—à–µ –º–∞—Ä–∫–µ—Ä–∞
                                    return new ol.geom.Point([center[0] + offset[0], center[1] + offset[1]]);
                                },
                                text: new ol.style.Text({
                                    text: `${feature.get('name')}\n${feature.get('size')} –≥–∞`,
                                    font: '12px Arial',
                                    fill: new ol.style.Fill({
                                        color: '#333'
                                    }),
                                    stroke: new ol.style.Stroke({
                                        color: 'white',
                                        width: 3
                                    }),
                                    textAlign: 'center',
                                    offsetY: -10
                                })
                            })
                        ];
                    }
                });

                map.addLayer(marker);
                fieldMarkers.push(marker);
            });
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–ª—è
        function highlightField(fieldId) {
            const field = fields.find(f => f.id === fieldId);
            if (field) {
                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª–µ
                map.getView().setCenter(
                    ol.proj.fromLonLat([field.locations.center.lng, field.locations.center.lat])
                );
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–µ
                highlightSelectedField(fieldId);
            }
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—è
        function highlightSelectedField(fieldId) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è –∫ –æ–±—ã—á–Ω–æ–º—É —Å—Ç–∏–ª—é
            fieldPolygons.forEach((polygon, index) => {
                const field = fields[index];
                if (field) {
                    polygon.setStyle(new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: fieldId && field.id === fieldId ? '#ff4444' : '#667eea',
                            width: fieldId && field.id === fieldId ? 4 : 2
                        }),
                        fill: new ol.style.Fill({
                            color: fieldId && field.id === fieldId ? 'rgba(255, 68, 68, 0.3)' : 'rgba(102, 126, 234, 0.2)'
                        })
                    }));
                }
            });
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–ª—è –≤ —Å–ø–∏—Å–∫–µ –∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–µ–º—É
        function highlightFieldInList(fieldId) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
            clearFieldListHighlight();
            
            // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–ª—è –≤ —Å–ø–∏—Å–∫–µ
            const fieldElement = document.querySelector(`[data-field-id="${fieldId}"]`);
            if (fieldElement) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
                fieldElement.classList.add('field-item-highlighted');
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —ç–ª–µ–º–µ–Ω—Ç—É
                fieldElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤ —Å–ø–∏—Å–∫–µ
        function clearFieldListHighlight() {
            const highlightedElements = document.querySelectorAll('.field-item-highlighted');
            highlightedElements.forEach(element => {
                element.classList.remove('field-item-highlighted');
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ —Ç–æ—á–∫–∏
        async function checkPointLocation(lat, lng) {
            try {
                const response = await fetch('/api/fields/point-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lat, lng })
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
                
                const result = await response.json();
                const resultDiv = document.getElementById('point-result');
                
                if (result === false) {
                    resultDiv.innerHTML = '<div class="result">–¢–æ—á–∫–∞ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –Ω–∏ –æ–¥–Ω–æ–º—É –ø–æ–ª—é</div>';
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤—Å–µ—Ö –ø–æ–ª–µ–π
                    highlightSelectedField(null);
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤ —Å–ø–∏—Å–∫–µ
                    clearFieldListHighlight();
                } else {
                    resultDiv.innerHTML = `
                        <div class="result">
                            <strong>–¢–æ—á–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–æ–ª–µ:</strong><br>
                            ID: ${result.id}<br>
                            –ù–∞–∑–≤–∞–Ω–∏–µ: ${result.name}
                        </div>
                    `;
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ç–æ—á–∫–∞
                    highlightSelectedField(result.id);
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª–µ –≤ —Å–ø–∏—Å–∫–µ –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–µ–º—É
                    highlightFieldInList(result.id);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º ID –ø–æ–ª—è –≤ —Ñ–æ—Ä–º—É —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                    document.getElementById('field-id').value = result.id;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—á–∫–∏:', error);
                document.getElementById('point-result').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ—á–∫–∏</div>';
            }
        }

        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        async function calculateDistance(fieldId, lat, lng) {
            try {
                const response = await fetch('/api/fields/distance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fieldId, lat, lng })
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
                
                const distance = await response.json();
                const resultDiv = document.getElementById('distance-result');
                
                resultDiv.innerHTML = `
                    <div class="result">
                        <strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> ${distance.toFixed(2)} –º–µ—Ç—Ä–æ–≤
                    </div>
                `;

                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø–æ–ª–µ
                highlightSelectedField(fieldId);

                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –∫ –º–∞—Ä–∫–µ—Ä—É —Ç–æ—á–∫–∏
                addDistanceLabelToMarker(lat, lng, distance, fieldId);
                
                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏—é –¥–æ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–ª—è
                drawDistanceLine(lat, lng, fieldId);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è:', error);
                document.getElementById('distance-result').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è</div>';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –∫ –º–∞—Ä–∫–µ—Ä—É —Ç–æ—á–∫–∏
        function addDistanceLabelToMarker(lat, lng, distance, fieldId) {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥–ø–∏—Å—å, –µ—Å–ª–∏ –±—ã–ª–∞
            if (distanceLabelLayer) {
                map.removeLayer(distanceLabelLayer);
            }

            const field = fields.find(f => f.id === fieldId);
            if (!field) return;

            distanceLabelLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
                        })
                    ]
                }),
                style: new ol.style.Style({
                    text: new ol.style.Text({
                        text: `${distance.toFixed(1)} –º`,
                        font: 'bold 12px Arial',
                        fill: new ol.style.Fill({
                            color: '#333'
                        }),
                        stroke: new ol.style.Stroke({
                            color: 'white',
                            width: 3
                        }),
                        offsetY: -25,
                        textAlign: 'center'
                    })
                })
            });

            map.addLayer(distanceLabelLayer);
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏ –¥–æ —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–ª—è
        function drawDistanceLine(lat, lng, fieldId) {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ª–∏–Ω–∏—é, –µ—Å–ª–∏ –±—ã–ª–∞
            if (distanceLineLayer) {
                map.removeLayer(distanceLineLayer);
            }

            const field = fields.find(f => f.id === fieldId);
            if (!field) return;

            const startPoint = ol.proj.fromLonLat([lng, lat]);
            const endPoint = ol.proj.fromLonLat([field.locations.center.lng, field.locations.center.lat]);

            distanceLineLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: [
                        new ol.Feature({
                            geometry: new ol.geom.LineString([startPoint, endPoint])
                        })
                    ]
                }),
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#ff4444',
                        width: 2,
                        lineDash: [5, 5]
                    })
                })
            });

            map.addLayer(distanceLineLayer);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
        document.getElementById('point-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const lat = parseFloat(document.getElementById('lat').value);
            const lng = parseFloat(document.getElementById('lng').value);
            checkPointLocation(lat, lng);
        });

        document.getElementById('distance-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const fieldId = parseInt(document.getElementById('field-id').value);
            const lat = parseFloat(document.getElementById('distance-lat').value);
            const lng = parseFloat(document.getElementById('distance-lng').value);
            calculateDistance(fieldId, lat, lng);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è ID –ø–æ–ª—è –≤ —Ñ–æ—Ä–º–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        document.getElementById('field-id').addEventListener('change', function(e) {
            const fieldId = parseInt(e.target.value);
            if (fieldId > 0) {
                highlightSelectedField(fieldId);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadFields();
        });
    </script>
</body>
</html> 